import { useEffect, useRef, useState } from 'react';
import { Link } from 'wouter';
import { Github, Mail, FileText, ExternalLink, ChevronDown, Lock } from 'lucide-react';

/**
 * Design Philosophy: Cryptographic Minimalism
 * - Dark navy background with cyan/purple accents
 * - Prominent hero section with name, picture, and introduction
 * - Privacy-themed navigation system
 * - Interactive DP trajectory demo as centerpiece
 * - Asymmetric layout: 60% content, 40% demo
 */

export default function Home() {
  const bgCanvasRef = useRef<HTMLCanvasElement>(null);
  const demoCanvasRef = useRef<HTMLCanvasElement>(null);
  const [epsilon, setEpsilon] = useState(1.2);
  const [activeSection, setActiveSection] = useState<'hero' | 'projects' | 'demo'>('hero');

  // Background particle animation
  useEffect(() => {
    const canvas = bgCanvasRef.current;
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    let W = 0,
      H = 0;
    let particles: Array<{
      x: number;
      y: number;
      vx: number;
      vy: number;
      r: number;
    }> = [];

    function resizeBg() {
      if (!canvas) return;
      W = canvas.width = window.innerWidth * devicePixelRatio;
      H = canvas.height = window.innerHeight * devicePixelRatio;
      const n = Math.floor((window.innerWidth * window.innerHeight) / 18000);
      particles = Array.from({ length: Math.max(40, n) }, () => ({
        x: Math.random() * W,
        y: Math.random() * H,
        vx: (Math.random() - 0.5) * 0.25 * devicePixelRatio,
        vy: (Math.random() - 0.5) * 0.25 * devicePixelRatio,
        r: (0.8 + Math.random() * 1.6) * devicePixelRatio,
      }));
    }

    resizeBg();
    window.addEventListener('resize', resizeBg);

    function bgLoop() {
      if (!ctx) return;
      ctx.clearRect(0, 0, W, H);

      for (const p of particles) {
        p.x += p.vx;
        p.y += p.vy;
        if (p.x < 0) p.x = W;
        if (p.x > W) p.x = 0;
        if (p.y < 0) p.y = H;
        if (p.y > H) p.y = 0;

        // Cyan dot
        if (!ctx) return;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(130, 230, 230, 0.12)';
        ctx.fill();

        // Purple connecting lines
        for (const q of particles) {
          const dx = p.x - q.x,
            dy = p.y - q.y;
          const d2 = dx * dx + dy * dy;
          if (d2 > 0 && d2 < (120 * devicePixelRatio) * (120 * devicePixelRatio)) {
            const a = 0.08 * (1 - d2 / ((120 * devicePixelRatio) * (120 * devicePixelRatio)));
            ctx.strokeStyle = `rgba(170, 140, 255, ${a})`;
            ctx.lineWidth = 1 * devicePixelRatio;
            ctx.beginPath();
            ctx.moveTo(p.x, p.y);
            ctx.lineTo(q.x, q.y);
            ctx.stroke();
          }
        }
      }
      requestAnimationFrame(bgLoop);
    }
    bgLoop();

    return () => window.removeEventListener('resize', resizeBg);
  }, []);

  // DP trajectory demo
  useEffect(() => {
    const canvas = demoCanvasRef.current;
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    let dW = 0,
      dH = 0;

    function resizeDemo() {
      if (!canvas) return;
      const rect = canvas.getBoundingClientRect();
      dW = canvas.width = rect.width * devicePixelRatio;
      dH = canvas.height = rect.height * devicePixelRatio;
      drawDemo(epsilon);
    }

    function randn() {
      let u = 0,
        v = 0;
      while (u === 0) u = Math.random();
      while (v === 0) v = Math.random();
      return Math.sqrt(-2 * Math.log(u)) * Math.cos(2 * Math.PI * v);
    }

    function drawDemo(eps: number) {
      if (!ctx) return;
      ctx.clearRect(0, 0, dW, dH);

      // Frame
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
      ctx.lineWidth = 1 * devicePixelRatio;
      ctx.strokeRect(
        10 * devicePixelRatio,
        10 * devicePixelRatio,
        dW - 20 * devicePixelRatio,
        dH - 20 * devicePixelRatio
      );

      const pad = 26 * devicePixelRatio;
      const x0 = pad,
        x1 = dW - pad;
      const yMid = dH * 0.58;

      // Base path: smooth curve
      const pts = [];
      const N = 42;
      for (let i = 0; i < N; i++) {
        const t = i / (N - 1);
        const x = x0 + (x1 - x0) * t;
        const y =
          yMid +
          Math.sin(t * Math.PI * 1.2) * (-0.22 * dH) +
          Math.sin(t * Math.PI * 3.0) * (-0.05 * dH);
        pts.push({ x, y });
      }

      // Noise scale ~ 1/eps
      const sigma = Math.min(22, Math.max(2.5, 18 / eps)) * devicePixelRatio;

      // Draw true path (white)
      ctx.lineWidth = 2 * devicePixelRatio;
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.75)';
      ctx.beginPath();
      ctx.moveTo(pts[0].x, pts[0].y);
      for (const p of pts) ctx.lineTo(p.x, p.y);
      ctx.stroke();

      // Draw noisy observations (cyan)
      ctx.lineWidth = 2 * devicePixelRatio;
      ctx.strokeStyle = 'rgba(130, 230, 230, 0.85)';
      ctx.beginPath();
      for (let i = 0; i < pts.length; i++) {
        const p = pts[i];
        const nx = p.x + randn() * sigma;
        const ny = p.y + randn() * sigma;
        if (i === 0) ctx.moveTo(nx, ny);
        else ctx.lineTo(nx, ny);
      }
      ctx.stroke();

      // Legend
      ctx.font = `${12 * devicePixelRatio}px "IBM Plex Mono", monospace`;
      ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
      ctx.fillText('true path', pad, 24 * devicePixelRatio);
      ctx.fillStyle = 'rgba(130, 230, 230, 0.95)';
      ctx.fillText('DP-noisy telemetry', pad + 90 * devicePixelRatio, 24 * devicePixelRatio);

      // Epsilon label
      ctx.fillStyle = 'rgba(255, 255, 255, 0.55)';
      ctx.fillText(`noise ~ 1/Œµ`, dW - 110 * devicePixelRatio, 24 * devicePixelRatio);
    }

    resizeDemo();
    window.addEventListener('resize', resizeDemo);

    return () => window.removeEventListener('resize', resizeDemo);
  }, [epsilon]);

  const projects = [
    {
      title: 'Timing Inference (Client‚ÄìServer)',
      description: 'Offset inference, jitter modeling, attacker analysis',
      slug: 'timing-inference',
      icon: '‚è±Ô∏è',
    },
    {
      title: 'Realtime Systems & Privacy',
      description: 'Temporal constraints and privacy trade-offs in CPS',
      slug: 'realtime-systems',
      icon: '‚ö°',
    },
    {
      title: 'Differential Privacy Notes',
      description: 'Technical foundations and mathematical intuitions',
      slug: 'dp-notes',
      icon: 'üìê',
    },
    {
      title: 'Noise Types & Analysis',
      description: 'Laplace, Gaussian, and exponential mechanisms',
      slug: 'noise-types',
      icon: 'üîä',
    },
    {
      title: 'SoK: DP in CPS/Autonomous Systems',
      description: 'Taxonomy + Privacy/Utility/Safety scoring framework',
      slug: 'sok-dp-cps',
      icon: 'üó∫Ô∏è',
    },
    {
      title: 'How to Write a SoK',
      description: 'Methodology, structure, and best practices',
      slug: 'how-to-write-sok',
      icon: 'üìù',
    },
  ];

  return (
    <div className="relative min-h-screen bg-[#0b0f14] overflow-hidden">
      {/* Background particle animation */}
      <canvas
        ref={bgCanvasRef}
        className="fixed inset-0 -z-10 pointer-events-none"
        style={{ filter: 'blur(0.2px)' }}
      />

      {/* Radial gradient overlays */}
      <div
        className="fixed inset-0 -z-10 pointer-events-none"
        style={{
          background: `
            radial-gradient(1200px 800px at 20% 10%, rgba(130, 230, 230, 0.12), transparent 55%),
            radial-gradient(1000px 700px at 80% 20%, rgba(170, 140, 255, 0.12), transparent 55%)
          `,
        }}
      />

      {/* HERO SECTION */}
      <section className="relative z-0 min-h-screen flex items-center justify-center px-4 sm:px-6 lg:px-8 py-12 sm:py-20">
        {/* Hero Background Image */}
        <div
          className="absolute inset-0 -z-5 opacity-30"
          style={{
            backgroundImage: `url('https://private-us-east-1.manuscdn.com/sessionFile/iI6A7rYYtGQEkNqymPeM9x/sandbox/UeUQ0cMyd3n9MRK3XhN93g-img-1_1771787715000_na1fn_aGVyby1wcml2YWN5LWJn.png?x-oss-process=image/resize,w_1920,h_1920/format,webp/quality,q_80&Expires=1798761600&Policy=eyJTdGF0ZW1lbnQiOlt7IlJlc291cmNlIjoiaHR0cHM6Ly9wcml2YXRlLXVzLWVhc3QtMS5tYW51c2Nkbi5jb20vc2Vzc2lvbkZpbGUvaUk2QTdyWVl0R1FFa05xeW1QZU05eC9zYW5kYm94L1VlVVEwY015ZDNuOU1SSzNYaE45M2ctaW1nLTFfMTc3MTc4NzcxNTAwMF9uYTFmbl9hR1Z5Ynkxd2NtbDJZV081TFdKbi5wbmc~eC1vc3MtcHJvY2Vzcz1pbWFnZS9yZXNpemUsd18xOTIwLGhfMTkyMC9mb3JtYXQsd2VicC9xdWFsaXR5LHFfODAiLCJDb25kaXRpb24iOnsiRGF0ZUxlc3NUaGFuIjp7IkFXUzpFcG9jaFRpbWUiOjE3OTg3NjE2MDB9fX1dfQ__&Key-Pair-Id=K2HSFNDJXOU9YS&Signature=uLCcey0nzPAqH89sjC4Vw8NV~4rGMYNq5JTMXvMp-FD0bFWwMopzyKmyhkhdGOXOn6q1j1jkYBQ4nZcYiJ20YUP84hj1Xq1Txz685KKIgDol7PKJnhf13JfVns9llXiolMvMPbIDRHhDhYPTu~abeW~OewIufv2I8kovG4y8oQP9DXxCT7d5Xgdo4qNTI6WrgPDuL9AHs2qjs4W0FSWXQVTHgIkj9LMMpqp9PWdf7fGsHTSdOyxir7depfb~92NAC6~fVKQkG-ezvWv2IyMXKWQtmES20wlD6veI48fi8XF-R4nr8V1HyIBMCdzyRuvX~v6UUja9M1Ro1PLF29qnvw__')`,
            backgroundSize: 'cover',
            backgroundPosition: 'center',
          }}
        />

        <div className="relative z-10 max-w-4xl mx-auto text-center">
          {/* Avatar */}
          <div className="mb-8 sm:mb-10 flex justify-center">
            <div className="w-32 h-32 sm:w-48 sm:h-48 rounded-full border-2 border-[#82e6e6] shadow-2xl flex-shrink-0 bg-gradient-to-br from-[rgba(130,230,230,0.3)] to-[rgba(170,140,255,0.3)] flex items-center justify-center overflow-hidden">
              <div className="text-8xl sm:text-9xl">üë©‚Äçüî¨</div>
            </div>
          </div>

          {/* Name */}
          <h1 className="text-5xl sm:text-7xl font-bold font-mono text-[#e8eaed] mb-4 sm:mb-6 tracking-tight drop-shadow-lg">
            Maryam Ghorbanvirdi
          </h1>

          {/* Subtitle */}
          <p className="text-xl sm:text-2xl text-[rgba(255,255,255,0.85)] mb-6 sm:mb-8 leading-relaxed max-w-3xl mx-auto drop-shadow-md">
            PhD Student in Privacy & Security for Autonomous Systems
          </p>

          {/* Introduction */}
          <div className="bg-gradient-to-b from-[rgba(255,255,255,0.06)] to-[rgba(255,255,255,0.03)] border border-[rgba(255,255,255,0.12)] rounded-2xl p-6 sm:p-8 backdrop-blur-xl shadow-lg max-w-2xl mx-auto mb-8 sm:mb-12">
            <p className="text-base sm:text-lg text-[rgba(255,255,255,0.85)] leading-relaxed">
              I research privacy and security in autonomous systems, with a focus on <span className="text-[#82e6e6] font-semibold">differential privacy</span>. My work explores how to protect sensitive information in cyber-physical systems while maintaining utility and safety. I'm passionate about building privacy-preserving technologies that don't compromise system performance.
            </p>
          </div>

          {/* Social Links */}
          <div className="flex gap-3 sm:gap-4 flex-wrap justify-center mb-12 sm:mb-16">
            <a
              href="https://github.com/GhorbanvirdiMaryam"
              target="_blank"
              rel="noreferrer"
              className="inline-flex items-center gap-2 px-4 sm:px-6 py-2.5 sm:py-3 rounded-full bg-[rgba(255,255,255,0.06)] border border-[rgba(255,255,255,0.12)] text-[#e8eaed] text-xs sm:text-sm hover:bg-[rgba(255,255,255,0.09)] hover:border-[#82e6e6] hover:text-[#82e6e6] transition-all duration-200 hover:-translate-y-1 shadow-lg"
            >
              <Github size={18} />
              <span>GitHub</span>
            </a>
            <a
              href="mailto:maryam@example.com"
              className="inline-flex items-center gap-2 px-4 sm:px-6 py-2.5 sm:py-3 rounded-full bg-[rgba(255,255,255,0.06)] border border-[rgba(255,255,255,0.12)] text-[#e8eaed] text-xs sm:text-sm hover:bg-[rgba(255,255,255,0.09)] hover:border-[#82e6e6] hover:text-[#82e6e6] transition-all duration-200 hover:-translate-y-1 shadow-lg"
            >
              <Mail size={18} />
              <span>Email</span>
            </a>
            <a
              href="#"
              className="inline-flex items-center gap-2 px-4 sm:px-6 py-2.5 sm:py-3 rounded-full bg-[rgba(255,255,255,0.06)] border border-[rgba(255,255,255,0.12)] text-[#e8eaed] text-xs sm:text-sm hover:bg-[rgba(255,255,255,0.09)] hover:border-[#82e6e6] hover:text-[#82e6e6] transition-all duration-200 hover:-translate-y-1 shadow-lg"
            >
              <FileText size={18} />
              <span>CV</span>
            </a>
          </div>

          {/* Scroll Indicator */}
          <div className="flex justify-center animate-bounce">
            <ChevronDown size={32} className="text-[#82e6e6]" />
          </div>
        </div>
      </section>

      {/* PRIVACY-THEMED NAVIGATION / SECTIONS */}
      <section className="relative z-0 py-16 sm:py-24 px-4 sm:px-6 lg:px-8">
        <div className="max-w-6xl mx-auto">
          {/* Section Title */}
          <div className="text-center mb-12 sm:mb-16">
            <div className="flex items-center justify-center gap-3 mb-4">
              <Lock size={28} className="text-[#82e6e6]" />
              <h2 className="text-4xl sm:text-5xl font-bold font-mono text-[#e8eaed] tracking-tight">
                Research & Projects
              </h2>
            </div>
            <p className="text-base sm:text-lg text-[rgba(255,255,255,0.68)] max-w-2xl mx-auto">
              Explore my work in privacy, security, and differential privacy. Each project represents a layer of research into protecting sensitive information.
            </p>
          </div>

          {/* Projects Grid */}
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
            {projects.map((project, idx) => (
              <Link key={project.slug} href={`/${project.slug}`}>
                <a className="group relative overflow-hidden rounded-2xl border border-[rgba(255,255,255,0.12)] bg-gradient-to-b from-[rgba(255,255,255,0.06)] to-[rgba(255,255,255,0.03)] backdrop-blur-xl p-6 sm:p-8 hover:border-[#82e6e6] transition-all duration-300 hover:-translate-y-2 hover:shadow-2xl cursor-pointer min-h-[280px] sm:min-h-[300px] flex flex-col">
                  {/* Glow effect on hover */}
                  <div className="absolute inset-0 bg-gradient-to-br from-[rgba(130,230,230,0.1)] to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300" />

                  {/* Content */}
                  <div className="relative z-10 flex flex-col h-full">
                    <div className="text-5xl sm:text-6xl mb-4 group-hover:scale-110 transition-transform duration-300">
                      {project.icon}
                    </div>

                    <h3 className="text-lg sm:text-xl font-bold font-mono text-[#e8eaed] mb-2 sm:mb-3 group-hover:text-[#82e6e6] transition-colors">
                      {project.title}
                    </h3>

                    <p className="text-sm sm:text-base text-[rgba(255,255,255,0.68)] leading-relaxed flex-1">
                      {project.description}
                    </p>

                    <div className="mt-4 sm:mt-6 flex items-center gap-2 text-[#82e6e6] opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                      <span className="text-xs sm:text-sm font-semibold">Explore</span>
                      <ExternalLink size={16} />
                    </div>
                  </div>
                </a>
              </Link>
            ))}
          </div>
        </div>
      </section>

      {/* DP DEMO SECTION */}
      <section className="relative z-0 py-16 sm:py-24 px-4 sm:px-6 lg:px-8 bg-gradient-to-b from-transparent via-[rgba(130,230,230,0.05)] to-transparent">
        <div className="max-w-4xl mx-auto">
          {/* Section Title */}
          <div className="text-center mb-12 sm:mb-16">
            <h2 className="text-4xl sm:text-5xl font-bold font-mono text-[#e8eaed] mb-4 tracking-tight">
              DP Micro-Demo
            </h2>
            <p className="text-base sm:text-lg text-[rgba(255,255,255,0.68)]">
              Visualizing privacy in motion: see how epsilon controls the privacy-utility trade-off
            </p>
          </div>

          {/* Demo Card */}
          <div className="bg-gradient-to-b from-[rgba(255,255,255,0.06)] to-[rgba(255,25
(Content truncated due to size limit. Use line ranges to read remaining content)
